version: '3.8'

services:
  app:
    build: .
    container_name: smtp-imap-app
    environment:
      - NODE_ENV=development
      - MONGODB_URL=mongodb://mongo:27017/smtp-server
      - DISABLE_SSL=true
      - DISABLE_CHANGE_STREAMS=true

      # Mailbox API Configuration
      - MAILBOX_API_PORT=8080
      - MAILBOX_API_KEY=changeme

      # Server Configuration
      - SMTP_PORT=2525
      - SMTP_HOST=0.0.0.0
      - API_PORT=3000

      # Multi-Port SMTP Configuration
      - SMTP_25_PORT=25
      - SMTP_465_PORT=465
      - SMTP_587_PORT=587

      # LMTP Configuration
      - LMTP_24_PORT=24
      - LMTP_PORT=24
      - LMTP_SSL_PORT=1024
      - LMTP_SSL_ENABLED=false

      # IMAP Configuration
      - IMAP_143_PORT=143
      - IMAP_993_PORT=993
      - IMAP_PORT=143
      - IMAP_SSL_PORT=993
      - IMAP_SSL_ENABLED=false

      # Port 25 Forwarding Configuration
      - FORWARD_25_ENABLED=false
      - FORWARD_25_HOST=smtp.gmail.com
      - FORWARD_25_PORT=587
      - FORWARD_25_SECURE=true

      # Email Configuration
      - MAX_EMAIL_SIZE=10485760
      - ALLOWED_DOMAINS=example.com,test.com

      # Logging Configuration
      - LOG_LEVEL=info
      - ENABLE_CONSOLE_LOG=true

      # Webhook Configuration
      - WEBHOOK_ENABLED=false
      - WEBHOOK_TIMEOUT=10000
      - WEBHOOK_RETRIES=3

      # IP Selection Configuration
      - IP_SELECTION_ENABLED=false
      - IP_SELECTION_TIMEOUT=5000
      - IP_SELECTION_RETRIES=3
      - FALLBACK_IP=127.0.0.1

      # Rspamd Configuration
      - RSPAMD_ENABLED=false
      - RSPAMD_INBOUND_ENABLED=false
      - RSPAMD_OUTBOUND_ENABLED=false
      - RSPAMD_HOST=rspamd
      - RSPAMD_PORT=11333
      - RSPAMD_TIMEOUT=10000
      - RSPAMD_REJECT_THRESHOLD=15
      - RSPAMD_GREYLIST_THRESHOLD=6
      - RSPAMD_ADD_HEADER_THRESHOLD=4
    depends_on:
      - mongo
      - rspamd
    # For multi-IP support, use host networking (Linux only)
    # network_mode: host
    # If you do NOT need multi-IP, you can use bridge mode and map ports:
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
      - "24:24"
      - "1024:1024"
      - "143:143"
      - "993:993"
      - "2525:2525"
      - "3000:3000"
      - "8080:8080"

  mongo:
    image: mongo:6
    container_name: smtp-imap-mongo
    restart: always
    volumes:
      - mongo_data:/data/db

    environment:
      - MONGO_INITDB_DATABASE=smtp-server
    # Expose port if you want to connect from host
    ports:
      - "27017:27017"

  rspamd:
    image: rspamd/rspamd:3.7.4
    container_name: smtp-rspamd
    restart: always
    volumes:
      - rspamd_data:/var/lib/rspamd
      - rspamd_conf:/etc/rspamd/local.d
    ports:
      - "11333:11333"  # Normal worker
      - "11334:11334"  # Controller
    environment:
      - RSPAMD_PASSWORD=${RSPAMD_PASSWORD:-changeme}
    hostname: rspamd
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11334/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  mongo_data:
  rspamd_data:
  rspamd_conf: